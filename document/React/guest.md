## guest에 대한 SPA 설정

### sanctum의 문제
- 라라벨에서 제공하는 sanctum은 인증된 유저를 대상으로 CSRF, Session 인증을 사용한 인증을 제공한다. 아이디 비밀번호등의 개인의 인증 정보를 기반으로 인증된 유저의 세션 쿠키와 CSRF를 발급 받아 API 접속을 허가한다.
- sanctum의 API의 미들웨어를 통과하기 위해서는 인증을 해야 하는데, 인증 정보 없이 접근하는 유저의 경우에는 API를 이용할 수 없다. 로그인 정보가 아니더라도 인증 키 등을 사용해서 인증을 해야 sanctum 미들웨어의 API를 사용할 수 있다.
- 기본적으로 라라벨에서 로그인을 하게 되면, 로그인 된 유저에 해당하는 세션이 새로 발급이 되고 해당 세션이 Sanctum API의 인증 세션 정보가 된다.

### sanctum의 CSRF 보호 기능
```js
axios.get('/sanctum/csrf-cookie').then(response => {
    // Login...
});
```
- `/sanctum/csrf-cookie` 경로로 통신을 하면 CSRF 토큰의 역할을 하는 XSRF-TOKEN 쿠키를 발급 받는데, 이를 통해서 CSRF 인증을 할 수 있다. 
- sanctum의 미들웨어는 api 미들웨어 그룹에 설정하며, 라라벨의 기본 CSRF 인증을 담당하는 미들웨어는 web 미들웨어 그룹에 `\App\Http\Middleware\VerifyCsrfToken::class`으로 추가 되어 있다.
- sanctum의 API 통신 대상은 api 라우터이므로 발급 받은 XSRF-TOKEN 토큰으로 CSRF 보호의 유효성을 검사하는 부분도 api 라우터의 sanctum 미들웨어 부분에 해당한다. 
- sanctum 미들웨어는 로그인 세션이 발급된 유저에게만 API를 통과하므로 CSRF 인증만 단독으로 사용할 수는 없다. 따라서 게스트에게 CSRF 보호를 제공하려는 용도로 sanctum을 사용할 수는 없다.

### 게스트 유저에 대한 sanctum
- 게스트에게 sanctum 인증을 제공할 필요가 있는가? 게스트에게 로그인을 한 것과 같은 효과를 주는 것이 타당하냐는 질문에 해당한다.
- 게스트 중에서도 일부 유저에게만 제한된 API를 제공해야 할 경우 sanctum을 사용할 수 있다. 하지만, 로그인 세션을 발급하는 것과 같은 귀찮은 작업을 동반한다.
- 또한 기존에 로그인 된 유저도 게스트 페이지를 봐야 하는데 동일한 URL에 발급된 세션이라면 게스트용으로 발급된 세션에 의해 기존의 유저의 세션 쿠기 정보가 덮어 씌워져 새로 로그인을 해야 할 수 있다.
- 쿠키는 URL별로 설정을 할 수 있고, domain/path_a, domain/path_b, domain/path_c 등에 따로 발급 할 수 있다. 게스트 용의 URL을 설정(예를 들어 domain/api/path_g)을 하고 domain/api/path_g/*의 API를 사용하는 이 baseURL에 대한 인증 세션을 별도로 관리 한다면 게스트 유저에 대해 sanctum을 쓸 수 있지만 여러 모로 번거로운 작업이 필요하다. 기업에서는 생산성이 중요하기 때문에 이런 작업을 꼭 해야할 것이 아니라면 대체할 수 있는 방법을 찾는 것이 중요하다.

### 게스트의 라우터 그룹은?
- 라라벨은 WEB 라우터 그룹과 API 라우터 그룹을 가지고 있다. `routes/web.php`와 `routes/api.php`에 해당한다. `app/Http/Kernel.php`을 보면 기본적으로 WEB 미들웨어 그룹은 여러가지 미들웨어를 거쳐야 하는 반면 API 미들웨어 그룹은 거쳐야 할 미들웨어가 얼마 없다.
- web 라우터 그룹은 CSRF 토큰을 검증하고 세션 쿠키를 확인한다. CSRF 토큰 검증을 통해 자사 웹 서비스에서 발급된 페이지에서 접근했는지 확인을 하고, 세션 쿠키를 통해서 로그인 된 유저인지 확인을 한다. API를 web 라우터 그룹에 정의를 한다면 API통신 시 CSRF 토큰을 포함해야 하고, 발급된 세션 정보를 확인하는 과정이 동반된다.
- 그런데 SPA 웹을 사용한다면 초기 페이지 로딩 시 CSRF 토큰을 발급한 후 페이지 전환에 페이지를 새로 서버로 부터 발급을 받지 않으므로 CSRF 토큰을 발급 받지 못하는 문제가 발생한다. 이런 경우 페이지를 리프레시 할 수 있도록 SPA에서 실패시의 화면을 표시하든가 해야 한다.

