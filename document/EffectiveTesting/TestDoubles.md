# 테스트 더블

## 의존성

프로그래밍에서 코드는 의존성을 가지고 있다. 언어 자체의 내장 함수, 표준 라이브러리, 외부 라이브러리, 프레임워크에서 제공하는 기능에 대한 의존성을 가진다.

어떤 기능을 동작 시키려면, 대상이 되는 코드가 의존하는 코드를 함께 로드를 해 주어야 동작 시킬 수 있다.

언어 자체에 내장되어 별도의 import 없이 호출할 수 있는 경우에는 코드가 실행될 때 언어도 함께 실행되기 때문에 특별한 문제가 없지만, 외부 데이터를 import 하거나 프레임워크에 의한 전역에서 사용할 수 있는 기능을 이용하는 경우, 프레임워크가 로딩되지 않았을 때, 라이브러리가 사전 로딩되지 않은 경우 코드를 실행할 때 의존하는 기능을 이용할 수 없어 에러가 발생한다.

단순 코드만이 아니라, 외부의 상태에 따라 동작이 달라지는 경우 의존성이 있다면 외부에 연결된 서비스가 없다면 코드가 실행된 결과를 확인할 수 없다는 문제가 발생한다. 특정 외부 상태에 따라서 실행 결과가 달라지는 코드의 경우, 이 코드의 동작을 확인하기 위해서는 외부에 연결되는 서비스를 만들어 주어야 한다.

하지만 개발은 로컬 환경에서 이뤄지고 외부 상태를 실제 인프라 환경에 제공한 것과 같이 재현하기 어려운 경우가 많다.

이 때문에, 외부 상태를 유사하게 모방할 수 있는 기능을 제공해야 한다.

## 테스트 더블

외부의 상태에 따라 코드의 동작이 달라지게 하기 위해서는 프로그래밍 언어에 이를 매핑할 필요가 있다.

테스트 더블이란, 테스트하려는 함수나 객체가 의존하는 외부 상태를 언어의 값으로 받을 수 있도록 실제 외부 데이터나 상태를 매핑한 값이 아니더라도, 마치 매핑된 것과 같은 값을 이용하기 위한 모형을 뜻한다.

### 객체지향의 테스트 더블

객체에 이를 한정해서 말하면, 테스트하려는 객체가 의존하는 특정 상태가 내포된 객체를 테스트하려는 객체에 주입하여 테스트하려는 객체의 동작이 의존하는 객체의 상태에 따라 잘 동작하는지 확인하기 위한 것을 의미한다.

## 테스트 더블을 사용하는 예

### 격리 (의존성 분리)

프로그래밍 언어 이외의 외부의 상태에 따라 달라지는 동작을 테스트 할 때, 의존하는 대상을 실제로 연결하지 않고도 테스트할 수 있도록, 의존하는 대상을 테스트할 기능에 주입할 수 있도록 코드를 만들고 테스트 더블을 주입하여 코드의 동작을 확인할 수 있다.

### 제어 및 속도

테스트 환경은 실제 프로덕션 환경과 다를 수 있다. 이를 위해서 테스트 환경에서 실행하기 어렵거나, 느려서 동작을 확인하는데 오래 걸려 개발 시간에 지장을 주거나, 비결정적인 동작을 제어 가능한 가짜 객체로 대체하여 동작을 테스트할 때 빠르게 코드의 동작을 확인할 수 있도록 만들기 위해 테스트 더블을 사용한다.

## '더블'이라는 용어의 유래

배우를 대신하여 연기하는 스턴트 더블(Stunt Double)에서 유래한 용어로, 실제를 대신하여 어떤 엑션을 동작시킨다는 의미를 가진다.

프로그래밍 언어에서 테스트 더블은 대체 값 또는 대체 동작을 제공하는 코드를 의미한다.

## 테스트 더블의 종류

### Dummy

실제 로직의 동작 결과에 영향을 주지는 않지만, 로직을 동작시키기 위해서 전제 조건을 설정할 때, 자리를 채워주어야 하는 부분을 채우기 위한 역할을 가진 것

### Stub

실제 데이터는 아니지만 모형으로서 데이터나 객체의 동작을 모방한 대상을 건내주어, 검증하려는 대상의 로직을 실행시키기 위해 만드는 가짜 객체 또는 데이터

### Spy

스파이는 첩자를 의미하는 단어로, 로직의 동작 결과 뿐만 아니라 내부 실행 과정에서 어떤 일이 일어났는지 디버깅하기 위한 용도로 사용된다. 호출여부, 전달된 인자 등 다양한 정보를 기록하는 기능을 추가한 것으로서 정확한 로직의 동작을 확인하거나 디버깅을 위해서 사용한다.

Spy는 기록에 초점을 맞춘 개념이기 때문에 실제로 정확하게 동작하는 로직일 수도 있고, Dummy, Stub, Mock과 같은 테스트를 위해서 임시로 생성한 객체나 데이터일 수도 있다.

### Mock

Mock은 실물을 만들기 전에 실물의 외형이나 기능을 간단히 만든 Mock-up에서 유래한 말로, '모조품', '모의'라는 개념으로 이해된다.

Stub이 미리 준비된 값을 검증 대상(SUT)에 전달하여, 검증할 로직은 Stub을 입력값으로 동작의 적절성 여부를 확인하는 것과 달리, Mock은 모의하는 대상의 세팅이 문제 없는지 확인하는 용도로 사용된다.

Mock으로 만든 객체는 메소드를 어떤 순서에 따라 실행할지, 얼만큼 실행할지, 어떤 인자를 전달할지에 따라 메소드가 반환하는 결과값이 달라진다. 이러한 구성이 검증할 로직에 전달될 때 모의한 대상이 검증 로직 내에서 적절하게 동작을 하는지를 확인하여, 검증할 로직에 사용될 적절한 행위의 모형을 만드는 것이다.

Mock과 Stub의 개념을 구분하기 어려운 것은 일반적으로 Mock을 만들 때는 로직의 동작의 유효성을 검증하기 위한 Stub도 포함해서 Mock을 만들기 때문이다. 하지만 개념적으로는 Mock은 검증할 로직이 의존하는 대상의 모의를 잘 수행하고 있는가에 초점을 맞추기 때문에 Mock 객체의 유효성을 검증하는 방식인 반면, Stub은 의존하는 대상에 특정 값을 세팅했을 때, 검증 로직의 동작 결과가 올바르게 수행되었는지를 평가하기 위한 목적으로 만드는 것이다.
